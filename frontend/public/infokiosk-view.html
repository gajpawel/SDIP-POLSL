<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Infokiosk</title>
  <style>
    :root {
      --bg: #020203;
      --accent: #00e676;
      --muted: #86c4b3;
      --text: #e6f7ef;
      --danger: #ff5252;
      --card: #08121a;
      --sidebar-width: 70px;
      --item-height: 52px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: var(--text);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .kiosk-container {
      width: 459px;
      height: 816px;
      background: var(--bg);
      display: flex;
      flex-direction: row;
      border: 1px solid #333;
      box-sizing: border-box;
    }

    .content-wrap {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      width: calc(100% - var(--sidebar-width));
      overflow: hidden;
    }

    .header {
      font-size: 32px;
      font-weight: 900;
      color: var(--accent);
      text-transform: uppercase;
      margin-bottom: 10px;
      text-align: center;
    }

    .header-alt {
      font-weight: 900;
      text-transform: uppercase;
      margin-bottom: 14px;
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      margin-top: 5px;
      margin-left: 5px;
    }


    /* --- STYL LISTY --- */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      height: auto;
    }

    .train-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 4px 8px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      height: auto;
      justify-content: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Pierwszy wiersz: Główne info */
    .train-main {
      display: flex;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      width: 100%;
    }

    .tm-time { font-size: 14px; width: 50px; color: var(--text); display: flex; flex-direction: column; line-height: 0.9;}
    
    .tm-info { width: 100px; font-size: 12px; color: var(--muted); overflow: hidden;}
    
    .tm-dest { font-size: 14px; flex-grow: 1; color: var(--accent); text-transform: uppercase; overflow: hidden; text-overflow: ellipsis; padding: 0 5px;}
    
    .tm-plat { width: 40px; text-align: right; color: var(--text); font-size: 14px; }

    /* Drugi wiersz: Stacje pośrednie */
    .train-details {
      margin-top: 2px;
      font-size: 11px;
      color: #888;
      line-height: 1.2;
      
      /* Konfiguracja kontenera do przewijania */
      height: 26px; /* Wysokość na ok. 2 linie tekstu */
      overflow: hidden; 
      position: relative;
      display: block;
    }

    /* Wewnętrzny kontener z tekstem do animacji */
    .scroll-content {
      display: block;
      width: 100%;
      white-space: normal; /* Zawijanie tekstu */
    }

    /* Animacja przewijania góra-dół */
    .scrolling-y {
      animation: scrollUpDn 15s ease-in-out infinite;
    }

    @keyframes scrollUpDn {
        0%, 20% { transform: translateY(0); } /* Czekaj na górze */
        50%, 70% { transform: translateY(var(--scroll-offset)); } /* Przewiń w dół i czekaj */
        100% { transform: translateY(0); } /* Wróć na górę */
    }

    /* Pasek boczny */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--card);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 30px;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
    }

    .nav-btn {
      width: 50px; height: 50px;
      background: transparent; border: 2px solid var(--accent);
      border-radius: 10px; color: var(--accent);
      cursor: pointer; display: flex; justify-content: center; align-items: center;
    }
    .nav-btn:disabled {
        border-color: #444; color: #444; cursor: default;
    }
    .nav-btn svg { width: 30px; height: 30px; fill: currentColor; }

    .page-indicator {
        position: absolute; bottom: 5px; left: 10px; 
        font-size: 10px; color: #444;
    }
  </style>
</head>
<body>

  <div class="kiosk-container">
    <div class="content-wrap">
      <div class="header-alt">Plakatowy rozkład jazdy</div>
      <div class="header" id="header-title">Odjazdy</div>
      <div class="schedule-list" id="schedule-container"></div>
      <div class="page-indicator" id="page-info"></div>
    </div>

    <div class="sidebar">
      <button class="nav-btn" onclick="scrollList(-1)" id="btn-up">
        <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
      </button>

      <button class="nav-btn" onclick="toggleView()">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </button>

      <button class="nav-btn" onclick="scrollList(1)" id="btn-down">
        <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
      </button>
    </div>
  </div>

  <script>
    // 1. INICJALIZACJA ZMIENNYCH (Musi być na górze)
    const params = new URLSearchParams(window.location.search);
    const displayId = params.get("display_id") || "1"; 
    const ITEMS_PER_PAGE = 10;

    let stationId = 1; 
    let theme = 0;

    // Stan aplikacji
    let allData = [];
    let currentOffset = 0;
    let currentView = "departures"; // departures | arrivals
    let appearanceSocket = null;

    // 2. FUNKCJE WYGLĄDU (API + WebSocket)
    async function loadAppearance() {
        try {
            const response = await fetch(`/api/displays/display/${displayId}`);
            if(!response.ok) throw new Error("Brak API");
            const data = await response.json();
            
            applyDisplayAppearance(data);
        } catch (e) {
            console.warn("Nie udało się pobrać wyglądu, używam domyślnych.", e);
            applyDisplayAppearance({
                main_color: "00e676",
                background_color: "020203",
                font: "Segoe UI",
                theme: false,
                station_id: 1,
            });
        }
    }

    function applyDisplayAppearance(data) {
        document.documentElement.style.setProperty("--accent", "#" + data.main_color);
        document.documentElement.style.setProperty("--bg", "#" + data.background_color);
        document.body.style.fontFamily = `"${data.font}", Roboto, Arial, sans-serif`;
        document.title = data.alias ? `Wyświetlacz: ${data.alias}` : "Infokiosk - podgląd";

        theme = data.theme ? 1 : 0;
        
        applyTheme();

        // Sprawdzenie czy zmieniła się stacja. Jeśli tak, trzeba przeładować dane.
        const newStationId = parseInt(data.station_id || 1);
        if (stationId !== newStationId) {
            stationId = newStationId;
            // Pobieramy dane dla nowej stacji
            fetchSchedule();
        } else {
            stationId = newStationId;
        }
    }

    function applyTheme() {
        if (theme === 1) { // Jasny
            document.documentElement.style.setProperty("--text", "#000");
            document.documentElement.style.setProperty("--card", "#fff");
            document.documentElement.style.setProperty("--muted", "#444");
        } else { // Ciemny
            document.documentElement.style.setProperty("--text", "#e6f7ef");
            document.documentElement.style.setProperty("--card", "#08121a");
            document.documentElement.style.setProperty("--muted", "#86c4b3");
        }
    }

    function setupAppearanceWS() {
        if (appearanceSocket) appearanceSocket.close();
        
        appearanceSocket = new WebSocket(`/ws/displays/appearance/${displayId}`);
        
        appearanceSocket.onopen = () => console.log("Połączono z WS wyglądu");
        
        appearanceSocket.onmessage = async (event) => {
             console.log("Otrzymano aktualizację wyglądu");
             await loadAppearance();
        };
        
        appearanceSocket.onerror = (e) => console.error("Błąd WS wyglądu", e);
        appearanceSocket.onclose = () => {
            console.log("Appearance WS closed — reconnecting in 5s...");
            setTimeout(setupAppearanceWS, 5000);
        };
    }

    // 3. FUNKCJE DANYCH ROZKŁADU (Metoda GET zamiast WS)
    async function fetchSchedule() {
        // Używamy endpointów HTTP API zamiast WS
        // Zakładam, że endpointy zwracają taką samą strukturę JSON jak wcześniej WS
        const typeStr = currentView === "departures" ? "departures" : "arrivals";
        // UWAGA: Endpoint musi istnieć w backendzie (np. /api/displays/infokiosk-departures-data/ID)
        const url = `/api/displays/infokiosk-${typeStr}-data/${stationId}`; 

        console.log(`Pobieranie danych z: ${url}`);
        
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("Błąd sieci");
            const data = await res.json();
            
            allData = data;
            
            // Naprawa offsetu po odświeżeniu
            if (currentOffset >= allData.length) {
                currentOffset = Math.max(0, allData.length - ITEMS_PER_PAGE);
            }
            
            renderList();
        } catch (err) {
            console.error("Błąd pobierania rozkładu:", err);
            // Opcjonalnie: pokaż komunikat błędu na ekranie
        }
    }

    function renderList() {
        const container = document.getElementById("schedule-container");
        container.innerHTML = "";

        const visibleData = allData.slice(currentOffset, currentOffset + ITEMS_PER_PAGE);

        visibleData.forEach(t => {
            const el = document.createElement("div");
            el.className = "train-item";

            // Formatowanie stacji pośrednich
            let detailsText = "";
            if (t.intermediate && Array.isArray(t.intermediate) && t.intermediate.length > 0) {
                detailsText = t.intermediate
                    .map(i => {
                        if (typeof i === 'string') return i;
                        return `${i.station} ${i.time || ''}`.trim();
                    })
                    .join(", ");
            }

            el.innerHTML = `
                <div class="train-main">
                    <div class="tm-time">
                        <span>${t.time}</span>
                    </div>
                    <div class="tm-info">
                        <div>${t.train_type || ''} ${t.train_number || ''}</div>
                    </div>
                    <div class="tm-dest">${t.station}</div>
                    <div class="tm-plat">${t["platform/track"] || ""}</div>
                </div>
                <div class="train-details">
                    <span class="scroll-content">${detailsText}</span>
                </div>
            `;
            container.appendChild(el);
        });

        updateButtons();
        
        // Uruchamiamy obliczanie przewijania po wyrenderowaniu
        // setTimeout zapewnia, że DOM jest już gotowy do pomiaru wysokości
        setTimeout(applyScrollEffects, 50);
    }

    // Funkcja sprawdzająca czy tekst się mieści i dodająca animację
    function applyScrollEffects() {
        const detailsContainers = document.querySelectorAll('.train-details');
        
        detailsContainers.forEach(container => {
            const content = container.querySelector('.scroll-content');
            if(!content) return;

            // Sprawdzamy, czy wysokość tekstu jest większa niż wysokość kontenera
            if (content.scrollHeight > container.clientHeight) {
                // Obliczamy o ile trzeba przesunąć (plus mały margines)
                const overflow = content.scrollHeight - container.clientHeight;
                
                // Ustawiamy zmienną CSS dla animacji
                // Przesuwamy o różnicę wysokości z minusem
                container.style.setProperty('--scroll-offset', `-${overflow}px`);
                
                // Dodajemy klasę uruchamiającą animację
                content.classList.add('scrolling-y');
            } else {
                content.classList.remove('scrolling-y');
            }
        });
    }

    // 4. NAWIGACJA
    window.scrollList = (direction) => {
        const newOffset = currentOffset + (direction * ITEMS_PER_PAGE);

        if (direction === -1) {
            if (newOffset < 0) currentOffset = 0;
            else currentOffset = newOffset;
        } else {
            if (newOffset < allData.length) {
                currentOffset = newOffset;
            }
        }
        renderList();
    };

    function updateButtons() {
        const btnUp = document.getElementById("btn-up");
        const btnDown = document.getElementById("btn-down");

        if (btnUp) btnUp.disabled = (currentOffset === 0);
        if (btnDown) btnDown.disabled = (currentOffset + ITEMS_PER_PAGE >= allData.length);
    }

    window.toggleView = () => {
        currentView = (currentView === "departures") ? "arrivals" : "departures";
        
        const title = document.getElementById("header-title");
        title.textContent = (currentView === "departures") ? "ODJAZDY" : "PRZYJAZDY";
        
        // Resetujemy widok przy zmianie trybu
        currentOffset = 0; 
        allData = []; 
        renderList(); // Czyścimy listę wizualnie
        
        // Pobieramy nowe dane (statycznie)
        fetchSchedule();
    };

    // OBSŁUGA KLAWIATURY (NOWOŚĆ)
    document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
            e.preventDefault(); // Zapobiega przewijaniu strony
            toggleView();
        } else if (e.code === "ArrowUp") {
            scrollList(-1);
        } else if (e.code === "ArrowDown") {
            scrollList(1);
        }
    });

    // START APLIKACJI
    (async () => {
        // Najpierw pobierz wygląd (to ustawi stationId)
        await loadAppearance();
        
        // Uruchom nasłuchiwanie zmian wyglądu (to zostaje na WS zgodnie z prośbą)
        setupAppearanceWS();

        // Pobierz dane rozkładu (HTTP GET)
        fetchSchedule();
    })();

  </script>
</body>
</html>