<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Wyświetlacz zbiorczy peronowy – podgląd</title>

  <style>
    /* ---- KOLORY I GŁÓWNY STYL ---- */
    :root{
      --bg:#020203;
      --panel:#071018;
      --accent:#00e676;
      --muted:#86c4b3;
      --danger:#ff5252;
      --text:#e6f7ef;
      --card:#08121a;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg) 0%,#04040a 100%);
      color:var(--text);
    }

    .wrap{
      box-sizing:border-box;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      padding:1px;
    }

    /* ---- LISTA POŁĄCZEŃ ---- */

    .train-list{
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:10px;
    }

    .train-card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
    }

    .big-destination{
      font-size:clamp(22px,3vw,32px);
      font-weight:700;
      color:var(--accent);
      text-transform:uppercase;
    }

    .time-box {
        display: flex;
        align-items: baseline;
        gap: 8px;
    }

    .dep-time {
        font-size: clamp(20px, 3vw, 30px);
        font-weight: 700;
    }

    .delay {
        font-weight: 700;
        color: var(--danger);
        background: rgba(255, 82, 82, 0.15);
        padding: 4px 8px;
        border-radius: 6px;
        margin-top: 0;
    }

    .row-middle{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .track{
      font-size:18px;
      color:var(--accent);
      font-weight:700;
    }

    .edited{
      font-size:18px;
      color:var(--danger);
      font-weight:700;
    }

    .number{
      font-size:24px;
      font-weight:900;
    }

    /* Kontener dla stacji pośrednich - modyfikacja dla scrolla */
    .intermediate {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      display: block;
      font-size: 14px;
      color: var(--muted);
    }

    /* Element wewnętrzny do animacji */
    .scroll-content {
      display: inline-block;
      white-space: nowrap;
      padding-right: 20px; /* Bufor na końcu */
    }

    /* Animacja pozioma (lewo-prawo) */
    .scrolling-x {
      animation: scrollLeftRight 12s linear infinite;
    }

    @keyframes scrollLeftRight {
      0%, 20% { transform: translateX(0); } /* Czekaj na początku */
      50%, 70% { transform: translateX(var(--scroll-offset)); } /* Przewiń do końca i czekaj */
      100% { transform: translateX(0); } /* Wróć na początek */
    }

  </style>
</head>

<body>
  <div class="wrap">
    <!-- Miejsce na połączenia -->
    <div id="trainList" class="train-list"></div>
  </div>

  <script type="module">
    /* -----------------------------
       PARAMETRY WYGLĄDU Z URL
    ----------------------------- */
    const params = new URLSearchParams(window.location.search);
    const displayId = params.get("display_id");

    let maxIntermediates = 5;
    let theme, platformId;

    // 1. Ładowanie wyglądu
    async function loadAppearance() {
        try {
            const data = await fetch(`/api/displays/display/${displayId}`).then(r => r.json());
            applyDisplayAppearance(data);
            applyTheme();
        } catch (e) {
            console.error("Błąd pobierania wyglądu:", e);
        }
    }

    // 2. Funkcja stosująca wygląd
    function applyDisplayAppearance(data) {
        document.documentElement.style.setProperty("--accent", "#" + data.main_color);
        document.documentElement.style.setProperty("--bg", "#" + data.background_color);
        document.body.style.fontFamily = `"${data.font}", Roboto, Arial, sans-serif`;
        document.title = data.alias ? `Wyświetlacz: ${data.alias}` : "Wyświetlacz zbiorczy peronowy - podgląd";

        // Jeśli intermediates_number jest null, pokazujemy wszystkie (limit 999)
        if (data.intermediates_number === null || data.intermediates_number === undefined) {
            maxIntermediates = 999;
        } else {
            maxIntermediates = parseInt(data.intermediates_number, 10);
        }

        theme = data.theme ? 1 : 0;
        platformId = parseInt(data.platform_id);
    }

    // 3. Osobna funkcja ustawiająca jasny/ciemny motyw
    function applyTheme() {
        if (theme === 1) {
            // JASNY
            document.documentElement.style.setProperty("--text", "#000");
            document.documentElement.style.setProperty("--card", "#fff");
            document.documentElement.style.setProperty("--muted", "#444");
        }
        else {
            // CIEMNY
            document.documentElement.style.setProperty("--text", "#e6f7ef");
            document.documentElement.style.setProperty("--card", "#08121a");
            document.documentElement.style.setProperty("--muted", "#86c4b3");
        }
    }

    // Funkcja obliczająca i aplikująca przewijanie poziome
    function applyHorizontalScrollEffects() {
        const containers = document.querySelectorAll('.intermediate');
        
        containers.forEach(container => {
            const content = container.querySelector('.scroll-content');
            if (!content) return;

            // Sprawdzamy czy zawartość jest szersza niż kontener
            const overflow = content.scrollWidth - container.clientWidth;
            
            if (overflow > 0) {
                // Ustawiamy zmienną CSS z wartością przesunięcia (ujemną)
                container.style.setProperty('--scroll-offset', `-${overflow}px`);
                content.classList.add('scrolling-x');
            } else {
                content.classList.remove('scrolling-x');
                container.style.removeProperty('--scroll-offset');
            }
        });
    }

    // 4. Start – czekamy aż wygląd się załaduje
    await loadAppearance();
    
    connectAppearanceWS();

    function connectAppearanceWS() {
      // 5. WebSocket aktualizujący wygląd w locie
      const wsview = new WebSocket(`/ws/displays/appearance/${displayId}`);

      wsview.onmessage = async () => {
          console.log("Appearance updated — refreshing...");
          await loadAppearance();
      };
      wsview.onclose = () => {
          console.log("Appearance WS closed — reconnecting in 5s...");
          setTimeout(connectAppearanceWS, 5000);
      };
    }
    /* -----------------------------
       WEBSOCKET – ODBIÓR DANYCH
    ----------------------------- */
  connectWS();
  
  function connectWS() {
    if (!platformId) {
      document.getElementById("trainList").innerHTML =
        "<p style='color:red'>Brak ID peronu.</p>";
    } else {
      const ws = new WebSocket(`/ws/displays/platform-display-data/${platformId}`);

      ws.onmessage = (event) => {
        let arr;
        try {
          arr = JSON.parse(event.data);
        } catch {
          return;
        }

        if (!Array.isArray(arr)) return;

        const container = document.getElementById("trainList");
        container.innerHTML = ""; 

        arr.forEach((t) => {
          const div = document.createElement("div");
          div.className = "train-card";

          const delayHtml = t.departure_delay || t.is_cancelled
            ? `<span class="delay">${t.is_cancelled ? "Odwołany" : "+" + (t.departure_delay + "min")}</span>`
            : "";

          const originalIntermediate = Array.isArray(t.intermediate) ? t.intermediate : [];
          
          // Logika wyświetlania stacji pośrednich
          let intermediateText = "";
          if (maxIntermediates >= originalIntermediate.length) {
              intermediateText = originalIntermediate.join(", ");
          } else {
              const limitedIntermediate = originalIntermediate.slice(0, maxIntermediates);
              intermediateText = limitedIntermediate.join(", ");
          }

          div.innerHTML = `
            <div class="row-top">
              <div class="big-destination">${t.station || "—"}</div>
              <div class="time-box">
                <span class="dep-time">${t.departure_time || "--:--"}</span>
                ${delayHtml}
              </div>
            </div>

            <div class="row-middle">
              <div class="${t.bus || t.is_cancelled ? "edited" : "track"}">${t.bus ? "BUS" : t.is_cancelled ? "Odwołany" : ("Tor " + t.track || "")}</div>
              <div class="number">${t.train_type + " " + t.train_number || ""}</div>
            </div>

            <div class="intermediate">
              <span class="scroll-content">${intermediateText}</span>
            </div>
          `;

          container.appendChild(div);
        });
        
        // Uruchomienie obliczania przewijania po wyrenderowaniu
        setTimeout(applyHorizontalScrollEffects, 50);
      };
      ws.onclose = () => {
        console.log("Data WS closed — reconnecting in 5s...");
        setTimeout(connectWS, 5000);
      };
    }
  }
</script>

</body>
</html>